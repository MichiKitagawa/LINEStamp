# エラーハンドリング仕様 - LINEスタンプ自動申請アプリ

| 画面ID | エラー原因              | 発生契機                                         | 表示メッセージ                      | ユーザーの選択肢       | 裏側の処理・対応                                   |
| ---- | ------------------ | -------------------------------------------- | ---------------------------- | -------------- | ------------------------------------------ |
| P01  | 通信失敗               | `/auth/google` 呼び出し時にネットワーク不良                | 「通信に失敗しました。再試行してください」        | 「再試行する」        | ログ記録／UI状態を `idle` に戻す                      |
|      | セッション取得失敗          | `/auth/session` が 500 を返す                    | 「認証状態の確認に失敗しました」             | 「再読み込み」        | 状態保持せずにリロード                                |
| P02  | トークン取得失敗           | `/tokens/balance` が失敗                        | 「トークン残数の取得に失敗しました」           | 「再読み込み」        | ログ記録／ボタンは活性化状態のまま                          |
| P03  | Stripeセッション生成失敗    | `/tokens/checkout-session` がエラーを返す           | 「決済処理に失敗しました」                | 「もう一度試す」／「戻る」  | ログ記録／セッション再生成                              |
| P04  | 画像アップロード失敗         | `/images/upload` が失敗（500 or timeout）         | 「画像のアップロードに失敗しました」           | 「再試行する」／「戻る」   | アップロード状態を `idle` に戻す                       |
|      | バリデーションエラー         | PNG/JPEG以外 or 1〜8枚範囲外                        | 「1〜8枚のPNGまたはJPEG画像を選択してください」 | 「やり直す」         | アップロード処理を中断                                |
|      | トークン残数不足           | トークンが不足（5×画像数未満）                             | 「トークンが不足しています」               | 「トークンを購入する」    | P03へ遷移                                     |
| P04b | プリセット保存失敗          | `/stamps/set-preset` が500を返す                 | 「プリセットの保存に失敗しました」            | 「再試行する」／「戻る」   | 状態を `idle` に戻す                             |
| P05  | トークン消費処理失敗         | `/tokens/consume` が失敗                        | 「トークン消費に失敗しました」              | 「再試行する」／「戻る」   | `status = failed` にしてP09へ遷移                |
|      | スタンプ生成API失敗        | `/stamps/generate` が500 or `status = failed` | 「スタンプの生成に失敗しました」             | 「再試行する」／「戻る」   | `status = failed` に更新し、P09へ                |
| P06  | プレビュー画像取得失敗        | `/stamps/preview` が失敗                        | 「プレビュー画像の取得に失敗しました」          | 「再読み込み」／「戻る」   | API再実行または画面を初期化                            |
|      | プレビュー画像不足          | 画像枚数が8枚未満                                    | 「画像が不足しています（最大8枚）」           | 「画像を追加する」      | 戻るボタンでP04へ遷移                               |
| P07  | LINEセッション切れ        | `status = session_expired`                   | 「LINEに再ログインしてください」           | 「ログイン画面へ進む」    | `status = session_expired` にしてP10へ         |
|      | Puppeteer失敗（DOM操作） | タイムアウト・要素未検出など                               | 「申請処理中にエラーが発生しました」           | 「再試行する」／「戻る」   | `status = failed` に更新し、P09へ                |
| P09  | 再申請API失敗（2回目）      | `/stamps/retry` が失敗（retryCount < 上限）         | 「申請に再度失敗しました」                | 「戻る」／「ログを確認する」 | `retryCount++`、ログを submission_attempts に保存 |
|      | セッション期限切れで再申請不能    | `status = session_expired`                   | 「ログインセッションが切れています」           | 「再ログインする」      | P10へ遷移                                     |
| P10  | ログイン失敗（ユーザー操作）     | Puppeteer経由のログインが完了しない                       | 「ログインが完了しませんでした」             | 「キャンセル」／「再試行」  | キャンセル時はP09へ戻す／成功時はP07へ戻す                   |