# ユースケース一覧 - LINEスタンプ自動申請アプリ（Web版）

---

## 正常系ユースケース

---

### UC01: Googleアカウントでログインする
**アクター**: ユーザー  
**目的**: アカウントを認証し、スタンプ作成機能にアクセスする  
**前提条件**: 未ログイン状態  
**シナリオ**:
1. 「Googleでログイン」ボタンを押す
2. OAuth認証が開始される
3. 認証成功後、ユーザー情報が保存され、ログイン状態となる

---

### UC02: トークンを購入する
**アクター**: ユーザー  
**目的**: スタンプ生成・申請に必要なトークンを取得する  
**前提条件**: ログイン済み  
**シナリオ**:
1. 「トークン購入」ボタンを押す
2. Stripe決済ページで支払いを完了
3. トークンがアカウントに付与される
4. トークン残数が画面に表示される

**備考**:  
- 1画像 = トークン5枚  
- 8枚アップロードで合計40トークン消費

---

### UC03: スタンプ画像をアップロードする
**アクター**: ユーザー  
**目的**: スタンプ作成用の画像を選択・送信する  
**前提条件**: トークンが十分にあること（40枚以上）  
**シナリオ**:
1. ユーザーが画像を8枚以上選択
2. クライアント or サーバーで枚数と形式をチェック
3. 画像がアップロードされ、サーバーで一時保存される

---
### UC03b: プリセットを選択する  
**アクター**: ユーザー  
**目的**: 画像変換処理に使うスタンプのプリセットスタイルを選ぶ  
**前提条件**: UC03完了済み（アップロード画像がサーバーに保存されている）  
**シナリオ**:
1. P04 → P04b（プリセット選択画面）に遷移  
2. サムネイルからプリセット候補を選択  
3. 「このプリセットで生成」ボタンを押下  
4. 選択内容が stamp.preset_id に保存され、UC04（生成処理）へ進行

---

### UC04: スタンプを自動生成する
**アクター**: ユーザー  
**目的**: アップロード画像をLINEスタンプ形式に変換する  
**前提条件**: UC03完了済み  
**シナリオ**:
1. 「生成」ボタンを押す
2. トークンが40枚消費される（8画像 × 5）
3. 画像整形処理が実行される
4. ステータスが `generated` に更新される
5. プレビュー画面に遷移する

---

### UC05: スタンプを確認する
**アクター**: ユーザー  
**目的**: 生成されたスタンプを確認し、申請するか判断する  
**前提条件**: UC04完了済み  
**シナリオ**:
1. プレビュー画面で各スタンプを確認
2. 「申請」ボタンを押すと次フェーズへ進行

---

### UC06: スタンプをLINEに申請する
**アクター**: ユーザー  
**目的**: 作成済みスタンプをLINEに自動で申請する  
**前提条件**:  
- UC05で「申請」ボタンを押す  
- LINE Creators Marketにログインしていない場合、ログインが必要

**シナリオ**:
1. ステータスが `submitting` に更新される  
2. サーバーがPuppeteerを起動し、保存されたセッションCookieを読み込む  
3. セッションCookieが有効であれば申請処理を継続  
4. セッションCookieが無効 or 存在しない場合：  
   a. PuppeteerブラウザでLINE Creators Marketのログイン画面に遷移  
   b. ブラウザをユーザーに表示し、LINEアカウントでの手動ログインを促す（Googleログイン／メール＋パスワード）  
   c. ログイン完了後、自動でセッションCookieを保存  
   d. ステータスを `relogged_in` に更新し、自動で申請処理を再開  
5. スタンプ作成ページに遷移し、以下を自動操作：  
   - タイトル・説明・カテゴリ・タグの入力  
   - スタンプ画像（8枚）とメイン画像をアップロード  
   - 「申請」ボタンをクリック  
6. 成功時 → `submitted` に更新し、完了画面を表示  
7. 失敗時 → `failed` に更新し、UC09へ遷移

**備考**:
- 初回申請時は必ずログイン操作が必要（ユーザーがLINE Creators Marketの認証を行う）  
- 2回目以降はCookieの復元により自動申請が可能だが、有効期限切れ等で再ログインが必要になる場合もある
- 再ログインUIはポップアップ or 別画面で表示される

---

### UC07: ログアウトする
**アクター**: ユーザー  
**目的**: セッションを終了し、他のアカウントでログインできるようにする  
**前提条件**: ログイン状態  
**シナリオ**:
1. 「ログアウト」ボタンを押す
2. セッション情報が削除され、ログイン画面へ遷移

---

## 異常系ユースケース

---

### UC08: 中断した処理を再開する
**アクター**: システム / ユーザー  
**目的**: 通信切断・セッション切れ・ログイン未完了などから復帰し、途中から処理を再開する  
**前提条件**: スタンプに `generated` / `submitting` / `failed` / `session_expired` 状態がある

**シナリオ**:
1. アプリ起動時、対象スタンプのステータスを確認  
2. 状態に応じて復旧処理を行う：  
   - `generated` → プレビュー画面を表示  
   - `submitting` → `retryCount` の範囲内で申請処理を自動再開  
   - `failed` → エラー原因と再申請案内を表示  
   - `session_expired` → Puppeteerを再起動し、ユーザーにLINE Creators Marketのログインを再要求  
     - ログイン完了後、セッションCookieを保存し、UC06の申請処理を再開

**備考**:
- LINEのセッション有効期限は一定時間で切れるため、ログインは随時必要になる可能性がある  
- ログイン完了時に自動的に再申請を再開する処理を設ける  
- ログイン時のブラウザUIはユーザーに直接見える形で表示（ヘッドレス不可

---

### UC09: 申請処理中にエラーが発生する
**アクター**: システム / ユーザー  
**目的**: LINE申請処理中に失敗した場合にリカバリする  
**前提条件**: UC06実行中にPuppeteerのDOM操作・通信・認証等でエラーが発生

**シナリオ**:
1. Puppeteer実行中に失敗を検出：  
   - セッション切れ（ログイン画面表示）  
   - DOM検出エラー・タイムアウト・ボタンクリック不可など  
2. ステータスを `failed` または `session_expired` に更新  
3. エラー内容をログおよび画面に表示  
4. `session_expired` の場合 → UC08のログイン再要求フローへ  
5. その他のエラーは `retryCount` を更新し、条件を満たせばUC08から自動 or 手動再申請  
6. 再申請成功時 → `submitted` に更新し、完了画面へ遷移  

**備考**:
- セッション切れに限らず、ログイン認証の失敗や2段階認証の未完了も `session_expired` 扱いとする  
- 再ログイン後の処理はUC06を再実行して自動化する
- トークンは既に消費済みのため、再申請時に追加消費はなし